#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ”’ ë³´ì•ˆ ë° í’ˆì§ˆ ê²€ì¦ ì‹œì‘..."

# 1. TypeScript íƒ€ì… ì²´í¬
echo "ğŸ“ TypeScript íƒ€ì… ê²€ì¦ ì¤‘..."
npm run typecheck
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript íƒ€ì… ì—ëŸ¬ê°€ ìˆìŠµë‹ˆë‹¤. ì»¤ë°‹ì´ ì¤‘ë‹¨ë©ë‹ˆë‹¤."
  exit 1
fi

# 2. ESLint ë³´ì•ˆ ê·œì¹™ ê²€ì‚¬
echo "ğŸ›¡ï¸ ë³´ì•ˆ ê·œì¹™ ê²€ì‚¬ ì¤‘..."
npx eslint src --max-warnings 0
if [ $? -ne 0 ]; then
  echo "âŒ ESLint ë³´ì•ˆ ê·œì¹™ ìœ„ë°˜ì´ ìˆìŠµë‹ˆë‹¤. ì»¤ë°‹ì´ ì¤‘ë‹¨ë©ë‹ˆë‹¤."
  exit 1
fi

# 3. ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
echo "ğŸ” ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ ì¤‘..."
npm audit --audit-level=moderate
if [ $? -ne 0 ]; then
  echo "âš ï¸  ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ê²€í†  í›„ ì§„í–‰í•˜ì„¸ìš”."
  # ê²½ê³ ë§Œ í‘œì‹œ, ì»¤ë°‹ì€ í—ˆìš©
fi

# 4. ê¸ˆì§€ëœ íŒ¨í„´ ê²€ì‚¬
echo "ğŸš« ê¸ˆì§€ëœ íŒ¨í„´ ê²€ì‚¬ ì¤‘..."

# console.log ê²€ì‚¬
if grep -r "console\.log" src/ --include="*.ts" --include="*.tsx" | grep -v "debug-logger"; then
  echo "âŒ console.log ì‚¬ìš©ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. console.warn ë˜ëŠ” debugLoggerë¥¼ ì‚¬ìš©í•˜ì„¸ìš”."
  exit 1
fi

# any íƒ€ì… ê²€ì‚¬
if grep -r ": any" src/ --include="*.ts" --include="*.tsx" | grep -v "test\|spec"; then
  echo "âŒ any íƒ€ì… ì‚¬ìš©ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. unknown ë˜ëŠ” êµ¬ì²´ì ì¸ íƒ€ì…ì„ ì‚¬ìš©í•˜ì„¸ìš”."
  exit 1
fi

# Object[key] íŒ¨í„´ ê²€ì‚¬ (Object Injection ë°©ì§€)
if grep -r '\[[a-zA-Z_$][a-zA-Z0-9_$]*\]' src/ --include="*.ts" --include="*.tsx" | grep -v "Map\|hasOwnProperty\|test\|spec"; then
  echo "âš ï¸  Object[key] íŒ¨í„´ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. Map ë˜ëŠ” hasOwnPropertyë¥¼ ì‚¬ìš©í•˜ì„¸ìš”."
fi

# 5. Prettier í¬ë§· ê²€ì‚¬
echo "âœ¨ ì½”ë“œ í¬ë§· ê²€ì‚¬ ì¤‘..."
npx prettier --check src/
if [ $? -ne 0 ]; then
  echo "âŒ ì½”ë“œ í¬ë§·ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤. 'npm run format'ì„ ì‹¤í–‰í•˜ì„¸ìš”."
  exit 1
fi

echo "âœ… ëª¨ë“  ê²€ì¦ì„ í†µê³¼í–ˆìŠµë‹ˆë‹¤!"