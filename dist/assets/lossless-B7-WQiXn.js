var T=Object.defineProperty,b=(n,t)=>{for(var e in t)T(n,e,{get:t[e],enumerable:!0})},k={hSamp:0,quantTableSel:0,vSamp:0},y=class{buffer;index;constructor(n,t,e){this.buffer=new Uint8Array(n,t,e),this.index=0}get16(){const n=(this.buffer[this.index]<<8)+this.buffer[this.index+1];return this.index+=2,n}get8(){const n=this.buffer[this.index];return this.index+=1,n}},D=class{dimX=0;dimY=0;numComp=0;precision=0;components=[];read(n){let t=0,e;const r=n.get16();t+=2,this.precision=n.get8(),t+=1,this.dimY=n.get16(),t+=2,this.dimX=n.get16(),t+=2,this.numComp=n.get8(),t+=1;for(let o=1;o<=this.numComp;o+=1){if(t>r)throw new Error("ERROR: frame format error");const s=n.get8();if(t+=1,t>=r)throw new Error("ERROR: frame format error [c>=Lf]");e=n.get8(),t+=1,this.components[s]||(this.components[s]={...k}),this.components[s].hSamp=e>>4,this.components[s].vSamp=e&15,this.components[s].quantTableSel=n.get8(),t+=1}if(t!==r)throw new Error("ERROR: frame format error [Lf!=count]");return 1}},L={};b(L,{crc32:()=>v,crcTable:()=>d,createArray:()=>m,makeCRCTable:()=>R});var m=(...n)=>{if(n.length>1){const t=n[0],e=n.slice(1),r=[];for(let o=0;o<t;o++)r[o]=m(...e);return r}else return Array(n[0]).fill(void 0)},R=function(){let n;const t=[];for(let e=0;e<256;e++){n=e;for(let r=0;r<8;r++)n=n&1?3988292384^n>>>1:n>>>1;t[e]=n}return t},d=R(),v=function(n){const t=new Uint8Array(n);let e=-1;for(let r=0;r<t.length;r++)e=e>>>8^d[(e^t[r])&255];return(e^-1)>>>0},S=class E{static MSB=2147483648;l;th;v;tc;constructor(){this.l=m(4,2,16),this.th=[0,0,0,0],this.v=m(4,2,16,200),this.tc=[[0,0],[0,0],[0,0],[0,0]]}read(t,e){let r=0,o,s,h,i,a;const u=t.get16();for(r+=2;r<u;){if(o=t.get8(),r+=1,s=o&15,s>3)throw new Error("ERROR: Huffman table ID > 3");if(h=o>>4,h>2)throw new Error("ERROR: Huffman table [Table class > 2 ]");for(this.th[s]=1,this.tc[s][h]=1,i=0;i<16;i+=1)this.l[s][h][i]=t.get8(),r+=1;for(i=0;i<16;i+=1)for(a=0;a<this.l[s][h][i];a+=1){if(r>u)throw new Error("ERROR: Huffman table format error [count>Lh]");this.v[s][h][i][a]=t.get8(),r+=1}}if(r!==u)throw new Error("ERROR: Huffman table format error [count!=Lf]");for(i=0;i<4;i+=1)for(a=0;a<2;a+=1)this.tc[i][a]!==0&&this.buildHuffTable(e[i][a],this.l[i][a],this.v[i][a]);return 1}buildHuffTable(t,e,r){let o,s,h,i,a;for(s=0,h=0;h<8;h+=1)for(i=0;i<e[h];i+=1)for(a=0;a<256>>h+1;a+=1)t[s]=r[h][i]|h+1<<8,s+=1;for(h=1;s<256;h+=1,s+=1)t[s]=h|E.MSB;for(o=1,s=0,h=8;h<16;h+=1)for(i=0;i<e[h];i+=1){for(a=0;a<256>>h-7;a+=1)t[o*256+s]=r[h][i]|h+1<<8,s+=1;if(s>=256){if(s>256)throw new Error("ERROR: Huffman table error(1)!");s=0,o+=1}}}},x=class w{precision=[];tq=[0,0,0,0];quantTables=m(4,64);static enhanceQuantizationTable=function(t,e){for(let r=0;r<8;r+=1)t[e[0+r]]*=90,t[e[32+r]]*=90,t[e[16+r]]*=118,t[e[48+r]]*=49,t[e[40+r]]*=71,t[e[8+r]]*=126,t[e[56+r]]*=25,t[e[24+r]]*=106;for(let r=0;r<8;r+=1)t[e[0+8*r]]*=90,t[e[4+8*r]]*=90,t[e[2+8*r]]*=118,t[e[6+8*r]]*=49,t[e[5+8*r]]*=71,t[e[1+8*r]]*=126,t[e[7+8*r]]*=25,t[e[3+8*r]]*=106;for(let r=0;r<64;r+=1)t[r]>>=6};read(t,e){let r=0,o,s,h;const i=t.get16();for(r+=2;r<i;){if(o=t.get8(),r+=1,s=o&15,s>3)throw new Error("ERROR: Quantization table ID > 3");if(this.precision[s]=o>>4,this.precision[s]===0)this.precision[s]=8;else if(this.precision[s]===1)this.precision[s]=16;else throw new Error("ERROR: Quantization table precision error");if(this.tq[s]=1,this.precision[s]===8){for(h=0;h<64;h+=1){if(r>i)throw new Error("ERROR: Quantization table format error");this.quantTables[s][h]=t.get8(),r+=1}w.enhanceQuantizationTable(this.quantTables[s],e)}else{for(h=0;h<64;h+=1){if(r>i)throw new Error("ERROR: Quantization table format error");this.quantTables[s][h]=t.get16(),r+=2}w.enhanceQuantizationTable(this.quantTables[s],e)}}if(r!==i)throw new Error("ERROR: Quantization table error [count!=Lq]");return 1}},I={acTabSel:0,dcTabSel:0,scanCompSel:0},C=class{ah=0;al=0;numComp=0;selection=0;spectralEnd=0;components=[];read(n){let t=0,e,r;const o=n.get16();for(t+=2,this.numComp=n.get8(),t+=1,e=0;e<this.numComp;e+=1){if(this.components[e]={...I},t>o)throw new Error("ERROR: scan header format error");this.components[e].scanCompSel=n.get8(),t+=1,r=n.get8(),t+=1,this.components[e].dcTabSel=r>>4,this.components[e].acTabSel=r&15}if(this.selection=n.get8(),t+=1,this.spectralEnd=n.get8(),t+=1,r=n.get8(),this.ah=r>>4,this.al=r&15,t+=1,t!==o)throw new Error("ERROR: scan header format error [count!=Ns]");return 1}},p=function(){const n=new ArrayBuffer(2);return new DataView(n).setInt16(0,256,!0),new Int16Array(n)[0]===256}(),B=class g{static IDCT_P=[0,5,40,16,45,2,7,42,21,56,8,61,18,47,1,4,41,23,58,13,32,24,37,10,63,17,44,3,6,43,20,57,15,34,29,48,53,26,39,9,60,19,46,22,59,12,33,31,50,55,25,36,11,62,14,35,28,49,52,27,38,30,51,54];static TABLE=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63];static MAX_HUFFMAN_SUBTREE=50;static MSB=2147483648;static RESTART_MARKER_BEGIN=65488;static RESTART_MARKER_END=65495;buffer=null;stream=null;frame=new D;huffTable=new S;quantTable=new x;scan=new C;DU=m(10,4,64);HuffTab=m(4,2,50*256);IDCT_Source=[];nBlock=[];acTab=m(10,1);dcTab=m(10,1);qTab=m(10,1);marker=0;markerIndex=0;numComp=0;restartInterval=0;selection=0;xDim=0;yDim=0;xLoc=0;yLoc=0;outputData=null;restarting=!1;mask=0;numBytes=0;precision=void 0;components=[];getter=null;setter=null;output=null;selector=null;constructor(t,e){this.buffer=t??null,this.numBytes=e??0}decompress(t,e,r){return this.decode(t,e,r).buffer}decode(t,e,r,o){let s=0;const h=[];let i,a;const u=[],f=[];let l;t&&(this.buffer=t),o!==void 0&&(this.numBytes=o),this.stream=new y(this.buffer,e,r),this.buffer=null,this.xLoc=0,this.yLoc=0;let c=this.stream.get16();if(c!==65496)throw new Error("Not a JPEG file");for(c=this.stream.get16();c>>4!==4092||c===65476;){switch(c){case 65476:this.huffTable.read(this.stream,this.HuffTab);break;case 65484:throw new Error("Program doesn't support arithmetic coding. (format throw new IOException)");case 65499:this.quantTable.read(this.stream,g.TABLE);break;case 65501:this.restartInterval=this.readNumber()??0;break;case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:this.readApp();break;case 65534:this.readComment();break;default:if(c>>8!==255)throw new Error("ERROR: format throw new IOException! (decode)")}c=this.stream.get16()}if(c<65472||c>65479)throw new Error("ERROR: could not handle arithmetic code!");this.frame.read(this.stream),c=this.stream.get16();do{for(;c!==65498;){switch(c){case 65476:this.huffTable.read(this.stream,this.HuffTab);break;case 65484:throw new Error("Program doesn't support arithmetic coding. (format throw new IOException)");case 65499:this.quantTable.read(this.stream,g.TABLE);break;case 65501:this.restartInterval=this.readNumber()??0;break;case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:this.readApp();break;case 65534:this.readComment();break;default:if(c>>8!==255)throw new Error("ERROR: format throw new IOException! (Parser.decode)")}c=this.stream.get16()}switch(this.precision=this.frame.precision,this.components=this.frame.components,this.numBytes||(this.numBytes=Math.round(Math.ceil(this.precision/8))),this.numBytes===1?this.mask=255:this.mask=65535,this.scan.read(this.stream),this.numComp=this.scan.numComp,this.selection=this.scan.selection,this.numBytes===1?this.numComp===3?(this.getter=this.getValueRGB,this.setter=this.setValueRGB,this.output=this.outputRGB):(this.getter=this.getValue8,this.setter=this.setValue8,this.output=this.outputSingle):(this.getter=this.getValue8,this.setter=this.setValue8,this.output=this.outputSingle),this.selection){case 2:this.selector=this.select2;break;case 3:this.selector=this.select3;break;case 4:this.selector=this.select4;break;case 5:this.selector=this.select5;break;case 6:this.selector=this.select6;break;case 7:this.selector=this.select7;break;default:this.selector=this.select1;break}for(i=0;i<this.numComp;i+=1)a=this.scan.components[i].scanCompSel,this.qTab[i]=this.quantTable.quantTables[this.components[a].quantTableSel],this.nBlock[i]=this.components[a].vSamp*this.components[a].hSamp,this.dcTab[i]=this.HuffTab[this.scan.components[i].dcTabSel][0],this.acTab[i]=this.HuffTab[this.scan.components[i].acTabSel][1];for(this.xDim=this.frame.dimX,this.yDim=this.frame.dimY,this.numBytes===1?this.outputData=new Uint8Array(new ArrayBuffer(this.xDim*this.yDim*this.numBytes*this.numComp)):this.outputData=new Uint16Array(new ArrayBuffer(this.xDim*this.yDim*this.numBytes*this.numComp)),s+=1;;){for(u[0]=0,f[0]=0,i=0;i<10;i+=1)h[i]=1<<this.precision-1;if(this.restartInterval===0){for(c=this.decodeUnit(h,u,f);c===0&&this.xLoc<this.xDim&&this.yLoc<this.yDim;)this.output(h),c=this.decodeUnit(h,u,f);break}for(l=0;l<this.restartInterval&&(this.restarting=l===0,c=this.decodeUnit(h,u,f),this.output(h),c===0);l+=1);if(c===0&&(this.markerIndex!==0?(c=65280|this.marker,this.markerIndex=0):c=this.stream.get16()),!(c>=g.RESTART_MARKER_BEGIN&&c<=g.RESTART_MARKER_END))break}c===65500&&s===1&&(this.readNumber(),c=this.stream.get16())}while(c!==65497&&this.xLoc<this.xDim&&this.yLoc<this.yDim&&s===0);return this.outputData}decodeUnit(t,e,r){return this.numComp===1?this.decodeSingle(t,e,r):this.numComp===3?this.decodeRGB(t,e,r):-1}select1(t){return this.getPreviousX(t)}select2(t){return this.getPreviousY(t)}select3(t){return this.getPreviousXY(t)}select4(t){return this.getPreviousX(t)+this.getPreviousY(t)-this.getPreviousXY(t)}select5(t){return this.getPreviousX(t)+(this.getPreviousY(t)-this.getPreviousXY(t)>>1)}select6(t){return this.getPreviousY(t)+(this.getPreviousX(t)-this.getPreviousXY(t)>>1)}select7(t){return(this.getPreviousX(t)+this.getPreviousY(t))/2}decodeRGB(t,e,r){if(this.selector===null)throw new Error("decode hasn't run yet");let o,s,h,i,a,u,f;for(t[0]=this.selector(0),t[1]=this.selector(1),t[2]=this.selector(2),i=0;i<this.numComp;i+=1)for(h=this.qTab[i],o=this.acTab[i],s=this.dcTab[i],a=0;a<this.nBlock[i];a+=1){for(u=0;u<this.IDCT_Source.length;u+=1)this.IDCT_Source[u]=0;let l=this.getHuffmanValue(s,e,r);if(l>=65280)return l;for(t[i]=this.IDCT_Source[0]=t[i]+this.getn(r,l,e,r),this.IDCT_Source[0]*=h[0],f=1;f<64;f+=1){if(l=this.getHuffmanValue(o,e,r),l>=65280)return l;if(f+=l>>4,(l&15)===0){if(l>>4===0)break}else this.IDCT_Source[g.IDCT_P[f]]=this.getn(r,l&15,e,r)*h[f]}}return 0}decodeSingle(t,e,r){if(this.selector===null)throw new Error("decode hasn't run yet");let o,s,h,i;for(this.restarting?(this.restarting=!1,t[0]=1<<this.frame.precision-1):t[0]=this.selector(),s=0;s<this.nBlock[0];s+=1){if(o=this.getHuffmanValue(this.dcTab[0],e,r),o>=65280)return o;if(h=this.getn(t,o,e,r),i=h>>8,i>=g.RESTART_MARKER_BEGIN&&i<=g.RESTART_MARKER_END)return i;t[0]+=h}return 0}getHuffmanValue(t,e,r){let o,s;if(!this.stream)throw new Error("stream not initialized");if(r[0]<8?(e[0]<<=8,s=this.stream.get8(),s===255&&(this.marker=this.stream.get8(),this.marker!==0&&(this.markerIndex=9)),e[0]|=s):r[0]-=8,o=t[e[0]>>r[0]],(o&g.MSB)!==0){if(this.markerIndex!==0)return this.markerIndex=0,65280|this.marker;e[0]&=65535>>16-r[0],e[0]<<=8,s=this.stream.get8(),s===255&&(this.marker=this.stream.get8(),this.marker!==0&&(this.markerIndex=9)),e[0]|=s,o=t[(o&255)*256+(e[0]>>r[0])],r[0]+=8}if(r[0]+=8-(o>>8),r[0]<0)throw new Error("index="+r[0]+" temp="+e[0]+" code="+o+" in HuffmanValue()");return r[0]<this.markerIndex?(this.markerIndex=0,65280|this.marker):(e[0]&=65535>>16-r[0],o&255)}getn(t,e,r,o){let s,h;if(this.stream===null)throw new Error("stream not initialized");if(e===0)return 0;if(e===16)return t[0]>=0?-32768:32768;if(o[0]-=e,o[0]>=0){if(o[0]<this.markerIndex&&!this.isLastPixel())return this.markerIndex=0,(65280|this.marker)<<8;s=r[0]>>o[0],r[0]&=65535>>16-o[0]}else{if(r[0]<<=8,h=this.stream.get8(),h===255&&(this.marker=this.stream.get8(),this.marker!==0&&(this.markerIndex=9)),r[0]|=h,o[0]+=8,o[0]<0){if(this.markerIndex!==0)return this.markerIndex=0,(65280|this.marker)<<8;r[0]<<=8,h=this.stream.get8(),h===255&&(this.marker=this.stream.get8(),this.marker!==0&&(this.markerIndex=9)),r[0]|=h,o[0]+=8}if(o[0]<0)throw new Error("index="+o[0]+" in getn()");if(o[0]<this.markerIndex)return this.markerIndex=0,(65280|this.marker)<<8;s=r[0]>>o[0],r[0]&=65535>>16-o[0]}return s<1<<e-1&&(s+=(-1<<e)+1),s}getPreviousX(t=0){if(this.getter===null)throw new Error("decode hasn't run yet");return this.xLoc>0?this.getter(this.yLoc*this.xDim+this.xLoc-1,t):this.yLoc>0?this.getPreviousY(t):1<<this.frame.precision-1}getPreviousXY(t=0){if(this.getter===null)throw new Error("decode hasn't run yet");return this.xLoc>0&&this.yLoc>0?this.getter((this.yLoc-1)*this.xDim+this.xLoc-1,t):this.getPreviousY(t)}getPreviousY(t=0){if(this.getter===null)throw new Error("decode hasn't run yet");return this.yLoc>0?this.getter((this.yLoc-1)*this.xDim+this.xLoc,t):this.getPreviousX(t)}isLastPixel(){return this.xLoc===this.xDim-1&&this.yLoc===this.yDim-1}outputSingle(t){if(this.setter===null)throw new Error("decode hasn't run yet");this.xLoc<this.xDim&&this.yLoc<this.yDim&&(this.setter(this.yLoc*this.xDim+this.xLoc,this.mask&t[0]),this.xLoc+=1,this.xLoc>=this.xDim&&(this.yLoc+=1,this.xLoc=0))}outputRGB(t){if(this.setter===null)throw new Error("decode hasn't run yet");const e=this.yLoc*this.xDim+this.xLoc;this.xLoc<this.xDim&&this.yLoc<this.yDim&&(this.setter(e,t[0],0),this.setter(e,t[1],1),this.setter(e,t[2],2),this.xLoc+=1,this.xLoc>=this.xDim&&(this.yLoc+=1,this.xLoc=0))}setValue8(t,e){if(!this.outputData)throw new Error("output data not ready");p?this.outputData[t]=e:this.outputData[t]=(e&255)<<8|e>>8&255}getValue8(t){if(this.outputData===null)throw new Error("output data not ready");if(p)return this.outputData[t];{const e=this.outputData[t];return(e&255)<<8|e>>8&255}}setValueRGB(t,e,r=0){this.outputData!==null&&(this.outputData[t*3+r]=e)}getValueRGB(t,e){if(this.outputData===null)throw new Error("output data not ready");return this.outputData[t*3+e]}readApp(){if(this.stream===null)return null;let t=0;const e=this.stream.get16();for(t+=2;t<e;)this.stream.get8(),t+=1;return e}readComment(){if(this.stream===null)return null;let t="",e=0;const r=this.stream.get16();for(e+=2;e<r;)t+=this.stream.get8(),e+=1;return t}readNumber(){if(this.stream===null)return null;if(this.stream.get16()!==4)throw new Error("ERROR: Define number format throw new IOException [Ld!=4]");return this.stream.get16()}};export{k as ComponentSpec,y as DataStream,B as Decoder,D as FrameHeader,S as HuffmanTable,x as QuantizationTable,I as ScanComponent,C as ScanHeader,L as Utils};
